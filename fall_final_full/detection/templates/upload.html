{% extends 'base.html' %}
{% load static %}
{% block title %}Image Upload{% endblock %}

{% block content %}

<style>
    .image-preview {
        max-height: 300px;
        object-fit: contain;
    }

    /* Loader Styles */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        color: white;
        font-size: 20px;
        z-index: 9999;
        display: none;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top-color: #ffffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .progress-text {
        margin-top: 15px;
        font-size: 22px;
    }
</style>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <h4 class="text-center">Upload an Image</h4>
            <div class="card p-4 shadow-sm">
                <form id="imageUploadForm" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-outline">
                        <input type="file" name="image" class="form-control" onchange="previewImage(event)">
                    </div>
                    <button type="submit" class="btn btn-primary mt-3 w-100">Submit</button>
                </form>
            </div>
        </div>
    </div>

    <div id="imageResults" class="row mt-4 justify-content-center" style="display: none;">
        <div class="col-md-5">
            <h5 class="text-center">Original Image</h5>
            <div class="card p-3 shadow-sm">
                <img id="preview" src="" class="img-fluid image-preview rounded" alt="Uploaded Image">
            </div>
        </div>
        <div class="col-md-5">
            <h5 class="text-center">Detected Image</h5>
            <div class="card p-3 shadow-sm">
                <img id="detectedImage" src="" class="img-fluid image-preview rounded" alt="Detected Image">
            </div>
        </div>
    </div>
</div>
<div style="margin-top: 75px;"></div>
<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <p class="progress-text" id="progressText">Processing... 0%</p>
</div>

<script>
    function previewImage(event) {
        const input = event.target;
        const preview = document.getElementById('preview');

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                preview.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    document.getElementById("imageUploadForm").addEventListener("submit", function (event) {
        event.preventDefault(); // Prevent default form submission

        const formData = new FormData(this);
        document.getElementById("loadingOverlay").style.display = "flex";

        let progress = 0;
        let progressText = document.getElementById("progressText");

        function updateProgress() {
            if (progress < 100) {
                progress += Math.floor(Math.random() * 15) + 5;
                if (progress > 100) progress = 100;
                progressText.innerText = `Processing... ${progress}%`;
                setTimeout(updateProgress, 500);
            }
        }

        updateProgress(); // Start progress simulation

        fetch("{% url 'upload_image' %}", {
            method: "POST",
            body: formData
        })
            .then(response => response.json()) // Expect JSON response
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById("preview").src = data.uploaded_image_url;
                    document.getElementById("detectedImage").src = data.detected_image_url;
                    document.getElementById("loadingOverlay").style.display = "none";
                    document.getElementById("imageResults").style.display = "flex"; // Show images
                } else {
                    console.error("Error processing image:", data.message);
                    document.getElementById("loadingOverlay").style.display = "none";
                }
            })
            .catch(error => {
                console.error("Error:", error);
                document.getElementById("loadingOverlay").style.display = "none";
            });
    });
</script>

{% endblock %}